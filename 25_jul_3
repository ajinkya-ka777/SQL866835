# --- Step 2: Set Access Control on Shared Folder ---
$envAcc     = $config.Environments.$envChoice.AccessControl
$folderPath = $envAcc.SharedFolder

try {
    if (-not (Test-Path $folderPath)) {
        New-Item -Path $folderPath -ItemType Directory -Force | Out-Null
        Write-Log "Created shared folder: $folderPath"
    }

    $acl = Get-Acl $folderPath

    # Remove 'Everyone' if specified
    if ($envAcc.RemoveEveryone) {
        foreach ($entry in $acl.Access) {
            if ($entry.IdentityReference.Value -eq "Everyone") {
                $acl.RemoveAccessRule($entry)
                Write-Log "Removed 'Everyone' permissions from $folderPath"
            }
        }
    }

    foreach ($user in $envAcc.Users) {
        $right = switch ($user.AccessRight.ToLower()) {
            "fullcontrol" { [System.Security.AccessControl.FileSystemRights]::FullControl }
            "modify"      { [System.Security.AccessControl.FileSystemRights]::Modify }
            default       { [System.Security.AccessControl.FileSystemRights]::Read }
        }
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule(
            $user.Account, $right, "ContainerInherit,ObjectInherit", "None", "Allow")
        $acl.SetAccessRule($rule)
        Write-Log "Set $($user.AccessRight) permission for $($user.Account) on $folderPath"
    }

    Set-Acl -Path $folderPath -AclObject $acl
    Write-Log "$envChoice folder permissions applied."
}
catch {
    Write-Log "Error applying permissions on $folderPath: $_" "ERROR"
}
