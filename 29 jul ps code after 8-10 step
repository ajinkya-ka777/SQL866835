param (
    [string]$ConfigPath = ".\config.json",
    [ValidateSet("DEV","TEST","PROD")]
    [string]$Environment
)

# Logging function
function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] $Message"
    Write-Output $logEntry
    Add-Content -Path $script:LogFile -Value $logEntry
}

# Self-elevation check
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "Please run this script as administrator." -ForegroundColor Red
    exit 1
}

# --- Load Config ---
if (-not (Test-Path $ConfigPath)) {
    Write-Host "Configuration file not found: $ConfigPath"
    exit 1
}
$config = Get-Content -Path $ConfigPath -Raw | ConvertFrom-Json
$script:LogFile = $config.LogFile

# --- Initialize Logging ---
if (Test-Path $script:LogFile) { Remove-Item $script:LogFile -Force }
Write-Log "Script started."

# --- Environment selection ---
$envOptions = @("DEV", "TEST", "PROD")
$envChoice = $null
if ($Environment) {
    $envChoice = $Environment.ToUpper()
} else {
    while ($envChoice -eq $null) {
        $input = Read-Host "Select environment (${($envOptions -join "/")})"
        if ($envOptions -contains $input.ToUpper()) {
            $envChoice = $input.ToUpper()
        } else {
            Write-Host "Invalid input. Please select DEV, TEST, or PROD."
        }
    }
}
Write-Log "Selected environment: $envChoice"

# --- Step 1: Enable Windows/IIS Features ---
Write-Log "Enabling Windows Features..."
foreach ($feature in $config.WindowsFeatures) {
    try {
        if (Get-Command Install-WindowsFeature -ErrorAction SilentlyContinue) {
            Install-WindowsFeature -Name $feature -IncludeManagementTools -ErrorAction Stop | Out-Null
        }
        elseif (Get-Command Enable-WindowsOptionalFeature -ErrorAction SilentlyContinue) {
            Enable-WindowsOptionalFeature -FeatureName $feature -Online -NoRestart -ErrorAction Stop | Out-Null
        }
        else {
            Write-Log "Cannot install $feature. Required command missing." "ERROR"
            continue
        }
        Write-Log "Installed feature: $feature"
    } catch {
        Write-Log "Failed to install $feature: $_" "ERROR"
    }
}

# --- Step 2: Set Access Control on Shared Folder ---
$envAcc     = $config.Environments.$envChoice.AccessControl
$folderPath = $envAcc.SharedFolder

try {
    if (-not (Test-Path $folderPath)) {
        New-Item -Path $folderPath -ItemType Directory -Force | Out-Null
        Write-Log "Created shared folder: $folderPath"
    }
    $acl = Get-Acl $folderPath

    if ($envAcc.RemoveEveryone) {
        foreach ($entry in $acl.Access) {
            if ($entry.IdentityReference.Value -eq "Everyone") {
                $acl.RemoveAccessRule($entry)
                Write-Log "Removed 'Everyone' permissions from $folderPath"
            }
        }
    }

    foreach ($user in $envAcc.Users) {
        $right = switch ($user.AccessRight.ToLower()) {
            "fullcontrol" { [System.Security.AccessControl.FileSystemRights]::FullControl }
            "modify"      { [System.Security.AccessControl.FileSystemRights]::Modify }
            default       { [System.Security.AccessControl.FileSystemRights]::Read }
        }
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule(
            $user.Account, $right, "ContainerInherit,ObjectInherit", "None", "Allow")
        $acl.SetAccessRule($rule)
        Write-Log "Set $($user.AccessRight) permission for $($user.Account) on $folderPath"
    }

    Set-Acl -Path $folderPath -AclObject $acl
    Write-Log "$envChoice folder permissions applied."
}
catch {
    Write-Log "Error applying permissions on $folderPath: $_" "ERROR"
}

# --- Step 3: Copy Venafi Tools ---
try {
    if (-not (Test-Path $config.ToolsCopy.DestTools)) {
        New-Item -ItemType Directory -Path $config.ToolsCopy.DestTools -Force | Out-Null
        Write-Log "Created tools folder: $($config.ToolsCopy.DestTools)"
    }
    Copy-Item -Path "$($config.ToolsCopy.SourceTools)\*" -Destination $config.ToolsCopy.DestTools -Recurse -Force
    Write-Log "Copied tools from $($config.ToolsCopy.SourceTools) to $($config.ToolsCopy.DestTools)"
} catch {
    Write-Log "Failed to copy tools: $_" "ERROR"
}

# --- Step 4: Copy Scripts Folder ---
try {
    Copy-Item -Path "$($config.ScriptsCopy.SourcePath)\*" -Destination $config.ScriptsCopy.DestinationPath -Recurse -Force
    Write-Log "Copied scripts from $($config.ScriptsCopy.SourcePath) to $($config.ScriptsCopy.DestinationPath)"
} catch {
    Write-Log "Failed to copy scripts: $_" "ERROR"
}

# --- Step 5: Set Time Zone ---
try {
    Set-TimeZone -Id $config.TimeZone
    Write-Log "Time zone set to $($config.TimeZone)"
} catch {
    Write-Log "Failed to set time zone: $_" "ERROR"
}

# --- Step 8: Install .NET Framework ---
Write-Log "Installing .NET Framework from installer..."
$dotNet = $config.'.NETFrameworkInstall'
if (Test-Path $dotNet.InstallerPath) {
    try {
        Start-Process -FilePath $dotNet.InstallerPath -ArgumentList $dotNet.SilentArgs -Wait -NoNewWindow
        Write-Log ".NET Framework installed from $($dotNet.InstallerPath)"
    } catch {
        Write-Log "Failed to install .NET Framework: $_" "ERROR"
    }
} else {
    Write-Log "Installer not found at $($dotNet.InstallerPath)" "ERROR"
}

# --- Step 9: Copy inetpub\wwwroot excluding specific files ---
$webRoot = $config.WebRootTransfer
$excludeList = $webRoot.ExcludeFiles

try {
    $filesToCopy = Get-ChildItem -Path $webRoot.Source -Recurse -File | Where-Object {
        $excludeList -notcontains $_.Name
    }

    foreach ($file in $filesToCopy) {
        $destPath = $file.FullName.Replace($webRoot.Source, $webRoot.Destination)
        $destDir = Split-Path $destPath
        if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
        }
        Copy-Item $file.FullName -Destination $destPath -Force
        Write-Log "Copied: $($file.Name) to $destPath"
    }

    Write-Log "inetpub\\wwwroot files copied (excluding default files)"
} catch {
    Write-Log "Failed to copy WWWRoot files: $_" "ERROR"
}

# --- Step 10: Copy webdocs folder ---
$webDocs = $config.WebDocsTransfer

try {
    if (-not (Test-Path $webDocs.Destination)) {
        New-Item -ItemType Directory -Path $webDocs.Destination -Force | Out-Null
        Write-Log "Created webdocs destination folder"
    }

    Copy-Item -Path "$($webDocs.Source)\*" -Destination $webDocs.Destination -Recurse -Force
    Write-Log "Copied all files from $($webDocs.Source) to $($webDocs.Destination)"
} catch {
    Write-Log "Failed to copy D:\webdocs: $_" "ERROR"
}

Write-Log "Script completed."
Write-Host "âœ… All tasks completed. Check log at $($config.LogFile)"
