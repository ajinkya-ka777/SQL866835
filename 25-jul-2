# Step 2: Set Access Control on PROD Shared Folder
$prodAcc = $config.Environments.PROD.AccessControl
$folderPath = $prodAcc.SharedFolder

if (-not (Test-Path $folderPath)) {
    New-Item -Path $folderPath -ItemType Directory -Force | Out-Null
}

$acl = Get-Acl $folderPath

# Remove 'Everyone' if set
if ($prodAcc.RemoveEveryone) {
    $acl.Access | Where-Object { $_.IdentityReference -eq "Everyone" } | ForEach-Object {
        $acl.RemoveAccessRule($_)
    }
}

# Add users with respective rights
foreach ($user in $prodAcc.Users) {
    $right = switch ($user.AccessRight.ToLower()) {
        "fullcontrol" { [System.Security.AccessControl.FileSystemRights]::FullControl }
        "modify"      { [System.Security.AccessControl.FileSystemRights]::Modify }
        default       { [System.Security.AccessControl.FileSystemRights]::Read }
    }
    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule(
        $user.Account, $right, "ContainerInherit,ObjectInherit", "None", "Allow")
    $acl.SetAccessRule($rule)
}

Set-Acl -Path $folderPath -AclObject $acl
Write-Host "PROD folder permissions applied."
