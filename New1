IF EXISTS (SELECT 1 FROM #DatabaseInfo WHERE DatabaseName = @dbname AND DBOwner = @loginname AND IsOrphaned IS NULL)
BEGIN
    IF OBJECT_ID('tempdb..#OrphanedUsers', 'U') IS NOT NULL
    BEGIN
        DROP TABLE #OrphanedUsers;
    END

    -- Creating a temporary table to store orphaned user information
    CREATE TABLE #OrphanedUsers (
        UserName NVARCHAR(255)
    );

    -- Capture the output of sp_change_users_login 'report'
    DECLARE @username NVARCHAR(255);

    DECLARE orphaned_user_cursor CURSOR FOR
    EXEC sp_change_users_login 'report';

    OPEN orphaned_user_cursor;

    FETCH NEXT FROM orphaned_user_cursor INTO @username;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Insert orphaned user into the temp table
        INSERT INTO #OrphanedUsers (UserName) VALUES (@username);

        FETCH NEXT FROM orphaned_user_cursor INTO @username;
    END

    CLOSE orphaned_user_cursor;
    DEALLOCATE orphaned_user_cursor;

    -- Update the IsOrphaned column based on #OrphanedUsers data
    UPDATE #DatabaseInfo
    SET IsOrphaned = CASE
        WHEN EXISTS (SELECT 1 FROM #OrphanedUsers ou WHERE ou.UserName = DBOwner) THEN 'YES'
        ELSE 'No'
    END
    WHERE DatabaseName = @dbname AND DBOwner = @loginname;

    DROP TABLE #OrphanedUsers;
END